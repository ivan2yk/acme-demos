-- 1
UPDATE (
        SELECT XX.CODIGO, XX.CODIGOUSUARIOHOST, XX.NOMBRE
        FROM USUARIO XX 
        INNER JOIN (    
            SELECT U.CODIGO UCODIGO,
            U.CODIGOUSUARIOHOST UCODIGOUSUARIOHOST,
            U.NOMBRE UNOMBRE
            FROM USUARIO U
            INNER JOIN (
                SELECT UX.CODIGO AS COD,    
                COUNT(1) OVER(PARTITION BY UX.CODIGOUSUARIOHOST) AS CANTIDAD,
                ROW_NUMBER() OVER(PARTITION BY UX.CODIGOUSUARIOHOST ORDER BY FECHACREACION DESC) AS ORDEN
                FROM USUARIO UX
                WHERE UPPER(SUBSTR(UX.CODIGOUSUARIOHOST, LENGTH(UX.CODIGOUSUARIOHOST)-2)) <> 'OLD'
                AND SUBSTR(UX.NOMBRE, 0, 1) <> '*'
            ) T ON U.CODIGO = T.COD
            WHERE T.CANTIDAD > 1 
            AND T.ORDEN > 1    
        ) YY 
        ON XX.CODIGO = YY.UCODIGO        
    ) VX
SET VX.CODIGOUSUARIOHOST = VX.CODIGOUSUARIOHOST||'OLD', VX.NOMBRE = '*'||VX.NOMBRE;

-- 2
DECLARE
    CURSOR USUARIOCUR IS
        SELECT U.*
        FROM USUARIO U
        INNER JOIN (
            SELECT UX.CODIGO AS COD,    
            COUNT(1) OVER(PARTITION BY UX.CODIGOUSUARIOHOST) AS CANTIDAD,
            ROW_NUMBER() OVER(PARTITION BY UX.CODIGOUSUARIOHOST ORDER BY FECHACREACION DESC) AS ORDEN
            FROM USUARIO UX
            WHERE UPPER(SUBSTR(UX.CODIGOUSUARIOHOST, LENGTH(UX.CODIGOUSUARIOHOST)-2)) <> 'OLD'
            AND SUBSTR(UX.NOMBRE, 0, 1) <> '*'
        ) T ON U.CODIGO = T.COD
        WHERE T.CANTIDAD > 1 
        AND T.ORDEN > 1
    FOR UPDATE OF U.CODIGOUSUARIOHOST, U.NOMBRE;
    
    USUARIORECORD   USUARIO%rowtype;    
BEGIN

    IF NOT(USUARIOCUR%ISOPEN) THEN
        OPEN USUARIOCUR;
    END IF;

    LOOP
        FETCH USUARIOCUR INTO USUARIORECORD;
        EXIT WHEN USUARIOCUR%NOTFOUND;
        
        DBMS_OUTPUT.PUT_LINE('ROW :'||USUARIORECORD.CODIGO);
        
        UPDATE USUARIO
        SET CODIGOUSUARIOHOST = CODIGOUSUARIOHOST||'OLD', NOMBRE = '*'||NOMBRE
        WHERE CURRENT OF USUARIOCUR;
        
    END LOOP;
    
    COMMIT;
    
    IF USUARIOCUR%ISOPEN THEN
        CLOSE USUARIOCUR;
    END IF;

END;

-- 3
MERGE
INTO    USUARIO trg
USING   (
    SELECT U.CODIGO,
    U.CODIGOUSUARIOHOST,
    U.NOMBRE
    FROM USUARIO U
    INNER JOIN (
        SELECT UX.CODIGO AS COD,    
        COUNT(1) OVER(PARTITION BY UX.CODIGOUSUARIOHOST) AS CANTIDAD,
        ROW_NUMBER() OVER(PARTITION BY UX.CODIGOUSUARIOHOST ORDER BY FECHACREACION DESC) AS ORDEN
        FROM USUARIO UX
        WHERE UPPER(SUBSTR(UX.CODIGOUSUARIOHOST, LENGTH(UX.CODIGOUSUARIOHOST)-2)) <> 'OLD'
        AND SUBSTR(UX.NOMBRE, 0, 1) <> '*'
    ) T ON U.CODIGO = T.COD
    WHERE T.CANTIDAD > 1 
    AND T.ORDEN > 1
        ) src
ON      (trg.CODIGO = src.CODIGO)
WHEN MATCHED THEN UPDATE
 SET trg.CODIGOUSUARIOHOST = trg.CODIGOUSUARIOHOST||'OLD', trg.NOMBRE = '*'||trg.NOMBRE;
